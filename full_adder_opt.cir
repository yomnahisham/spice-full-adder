
.include ./MOSFET_models_0p5_0p18-3.inc
.include ./subcircuits.cir

* Full adder (gate-level) optimized sizing using p=2n (p=10), n=5
* Computed stage scaling factors (equal stage effort):
* f = 10^(1/5) = 1.584893192
* NMOS base (unit) = 0.9u; stage scale factors (from input to output):
* s1=0.1585  s2=0.2510  s3=0.3970  s4=0.6300  s5=1.0000
* NMOS widths (u): 0.143u, 0.226u, 0.357u, 0.567u, 0.900u
* PMOS widths = 2 * NMOS widths

VDD vdd 0 DC 1.8

* Inputs: A, B, Ci
* We'll generate a sequence of input combinations by choosing different pulse phases
* so that across one period all combinations appear. Period chosen long enough.

VA A 0 PULSE(0 1.8 1n 1p 1p 40n 80n)
VB B 0 PULSE(0 1.8 2n 1p 1p 20n 40n)
VCi Ci 0 PULSE(0 1.8 4n 1p 1p 10n 20n)

* Internal nodes

* Stage mapping for Sum path (5 stages):
* G1 = XNOR(A,B)  -> sizes s1
* G2 = INVERTER     -> sizes s2
* G3 = XNOR(X, Ci) -> sizes s3
* G4 = INVERTER     -> sizes s4
* G5 = INVERTER (output buffer) -> sizes s5

* Instantiate gates with params Wn and Wp

* G1: XNOR(A,B)  (small)
XX1 vdd A B xnor1 0 XNOR Wn=0.143u Wp=0.286u
* G2: INV
XI1 vdd xnor1 xor1 0 INVERTER Wn=0.226u Wp=0.452u
* G3: XNOR(xor1, Ci)
XX2 vdd xor1 Ci xnor2 0 XNOR Wn=0.357u Wp=0.714u
* G4: INV
XI2 vdd xnor2 S 0 INVERTER Wn=0.567u Wp=1.134u

*EXTRA INVERSION NOT NEEDED
* G5: OUT buffer INV
*XI3 vdd xor2 S 0 INVERTER Wn=0.9u Wp=1.8u

* Carry path: compute AB and Ci&X then OR
* AB = A & B -> NAND then INV
XNA1 vdd A B nab 0 NAND Wn=0.226u Wp=0.452u
XIA1 vdd nab ab 0 INVERTER Wn=0.357u Wp=0.714u
* CiX = Ci & XOR1 (use XOR1 = xor1)
XNA2 vdd xor1 Ci nci_xor1 0 NAND Wn=0.226u Wp=0.452u
XIA2 vdd nci_xor1 ci_xor1 0 INVERTER Wn=0.357u Wp=0.714u
* OR of ab and ci_xor1 -> NOR then INV
XNO vdd ab ci_xor1 nor_out 0 NOR Wn=0.567u Wp=1.134u
XIO vdd nor_out Co 0 INVERTER Wn=0.9u Wp=1.8u

* Loads: put small capacitive loads and 1k series as in earlier parts
RloadS s S_load 1k
CloadS S_load 0 0.2p
RloadCo Co Co_load 1k
CloadCo Co_load 0 0.2p

* Measurements: measure delays for a chosen transition (A rising), and energy
* We'll measure over one period (80n)
.meas tran tPLH_S TRIG V(A) VAL=0.9 RISE=1 TARG V(S) VAL=0.9 RISE=1
.meas tran tPHL_S TRIG V(A) VAL=0.9 RISE=1 TARG V(S) VAL=0.9 FALL=1
.meas tran tPLH_C TRIG V(A) VAL=0.9 RISE=1 TARG V(Co) VAL=0.9 RISE=1
.meas tran tPHL_C TRIG V(A) VAL=0.9 RISE=1 TARG V(Co) VAL=0.9 FALL=1

* Energy on VDD integrated over 0 -> 80n
.meas tran Etotal INTEG V(vdd)*I(VDD) FROM=0 TO=80n
.meas tran Pavg PARAM='Etotal/80n'

.tran 85n uic

.plot v(S) v(Co) v(A) v(B) v(Ci) -I(VDD)

.end
